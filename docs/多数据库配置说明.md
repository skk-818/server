# Wire 多数据库依赖注入配置说明

## 概述

本项目使用 Wire 实现了两个 MySQL 数据库的依赖注入：
- **SystemDB**: 系统模块使用的数据库
- **ImDB**: IM 模块使用的数据库

## 配置文件

在 `etc/config.yaml` 中配置两个数据库：

```yaml
# 系统数据库配置
system_mysql:
  host: "115.190.245.139"
  port: 23006
  user: "root"
  password: "001233wjh"
  dbname: "skk_admin"
  charset: "utf8mb4"
  max_open_conns: 100
  max_idle_conns: 10

# IM数据库配置
im_mysql:
  host: "115.190.245.139"
  port: 23006
  user: "root"
  password: "001233wjh"
  dbname: "skk_im"  # 使用不同的数据库名
  charset: "utf8mb4"
  max_open_conns: 100
  max_idle_conns: 10
```

## 核心实现

### 1. 数据库类型定义 (`internal/core/mysql/mysql.go`)

```go
// SystemDB 系统数据库类型
type SystemDB struct {
	*gorm.DB
}

// ImDB IM数据库类型
type ImDB struct {
	*gorm.DB
}

func NewSystemDB(cfg *config.Mysql) (*SystemDB, error) {
	db, err := newMySQL(cfg)
	if err != nil {
		return nil, err
	}
	return &SystemDB{DB: db}, nil
}

func NewImDB(cfg *config.Mysql) (*ImDB, error) {
	db, err := newMySQL(cfg)
	if err != nil {
		return nil, err
	}
	return &ImDB{DB: db}, nil
}
```

### 2. 配置提供者 (`internal/core/config/config.go`)

```go
type Config struct {
	Logger      *Logger     `mapstructure:"logger" json:"logger" yaml:"logger"`
	SystemMySQL *Mysql      `mapstructure:"system-mysql" json:"system-mysql" yaml:"system-mysql"`
	ImMySQL     *Mysql      `mapstructure:"im-mysql" json:"im-mysql" yaml:"im-mysql"`
	// ...
}

func ProvideImMysqlConfig(cfg *Config) *Mysql {
	return cfg.ImMySQL
}
```

### 3. Wire Provider Set (`internal/core/provider_set.go`)

```go
var ProviderSet = wire.NewSet(
	// ...
	config.LoadConfig,

	// 数据库提供者
	NewSystemDBProvider,
	NewImDBProvider,
	// ...
)

// NewSystemDBProvider 提供系统数据库连接
func NewSystemDBProvider(cfg *config.Config) (*mysql.SystemDB, error) {
	return mysql.NewSystemDB(cfg.SystemMySQL)
}

// NewImDBProvider 提供IM数据库连接
func NewImDBProvider(cfg *config.Config) (*mysql.ImDB, error) {
	return mysql.NewImDB(cfg.ImMySQL)
}
```

## 使用方法

### System 模块使用 SystemDB

```go
package repo

import (
	"server/internal/core/mysql"
	"gorm.io/gorm"
)

type userRepo struct {
	db *gorm.DB
}

// 注入 SystemDB
func NewUserRepo(systemDB *mysql.SystemDB) repo.UserRepo {
	return &userRepo{
		db: systemDB.DB,
	}
}
```

### IM 模块使用 ImDB

```go
package repo

import (
	"server/internal/core/mysql"
	"gorm.io/gorm"
)

type messageRepo struct {
	db *gorm.DB
}

// 注入 ImDB
func NewMessageRepo(imDB *mysql.ImDB) *messageRepo {
	return &messageRepo{
		db: imDB.DB,
	}
}
```

## 重新生成 Wire 代码

修改配置后，需要重新生成 Wire 代码：

```bash
cd server
wire gen ./internal/di
```

## 关键点

1. **类型区分**: 通过 `SystemDB` 和 `ImDB` 两个不同的类型包装 `*gorm.DB`，让 Wire 能够区分注入
2. **配置隔离**: 在配置文件中使用 `system-mysql` 和 `im-mysql` 两个独立配置
3. **Provider 函数**: 使用 `NewSystemDBProvider` 和 `NewImDBProvider` 从 Config 中提取对应配置并创建数据库连接
4. **构造函数参数**: 在各模块的 repo 构造函数中，通过参数类型 (`*mysql.SystemDB` 或 `*mysql.ImDB`) 来指定使用哪个数据库

## 优势

- ✅ 类型安全：编译时检查，避免注入错误的数据库
- ✅ 清晰明确：通过类型名称就能知道使用的是哪个数据库
- ✅ 易于扩展：需要添加更多数据库时，只需创建新的类型包装器
- ✅ 自动注入：Wire 自动处理依赖关系，无需手动管理
